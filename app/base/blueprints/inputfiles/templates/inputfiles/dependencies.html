<div style="display:flex; align-items:center; ">
    <h2 style="flex:1">Input File Dependencies</h2>
    <button class="btn btn-primary" style="margin-right:10px;" onclick='create_new_dep()'>New Dependency</button>
</div>

<div id="dependency" class="card" style="padding:15px; margin-top:15px">
    {%with deps = file.dependencies() %}
    {% include "inputfiles/deps.html"%}
    {% endwith %}
</div>

<div class="modal fade" id="edit_dep_modal" tabindex="-1" role="dialog" aria-labelledby="edit_dep_modal_label"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 95vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="flex:1;" id="new_file_modal_label">Edit Dependency</h5>
                <button type="button btn-primary" style="margin-right:10px;" class="btn btn-primary" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">Close</span></button>
                <button type="button" class="btn btn-primary" accesskey="s" onclick="save_dependency()" aria-label="Save"><span
                        aria-hidden="true">Save</span></button>

            </div>
            <div class="modal-body">
                <form id="edit_dependency_form" method="post">
                    <input type="hidden" name="fileId" value="">
                    <input id="depId" type="hidden" name="depId" value="">

                    <div class="form-group">
                        <label for="dep_type" class="col-form-label">Select The Dependency Type:</label>
                        <select type="text" class="form-control" id="dep_type" name="type">
                            {% for k,v in input_file_types().items() %}
                                <option value="{{k}}" >{{v["display"]}}</option>
                            {% endfor %}
                        </select>
                        <small id="application_description"> {{list_vnv_executables()[0][1]}} </small>
                    </div>

                    <div class="form-group">
                        <label for="remoteName" class="col-form-label">Remote Name</label>
                        <input type="text" class="form-control" name="remoteName" id="remoteName">
                        <small>The location on the remote machine to store the file prior to execution.</small>
                    </div>
                    {% for k,v in input_file_types().items() %}
                        <div id="{{k}}-form">
                              {% include v["template"] %}
                        </div>
                    {% endfor %}

                    <script>
                        $( document ).ready(function() {

                            $('#dep_type').on('change', function() {
                                {% for k,v in input_file_types().items() %}
                                    $('#{{k}}-form').toggle($(this).val() === '{{k}}')
                                {% endfor %}
                            });
                            $('#dep_type').trigger('change')

                        });


                    </script>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

function create_new_dep() {
     $('#depId').val("")
     $('#fuploadlabel').html("Choose the file you want to upload")
     $('#dep_type').val("text").trigger('change')
     $('#edit_dep_modal').modal('show')
}

function edit_dependency(depId) {

    $.post('/inputfiles/dependency/get/{{file.id_}}?depId=' + depId, function(data) {
        $('#depId').val(depId)
        $('#dep_type').val(data["type"]).trigger("change")
        $('#remoteName').val(data["remoteName"])

        {% for k,v in input_file_types().items() %}
            if (data["type"] === '{{k}}') {
                {{v["set"]}}(data);
            }
        {%endfor%}

        $('#edit_dep_modal').modal('show')
    })
}

function view_uploaded_file() {
    alert("Not implemented yet")
}

function save_dependency() {

    var formData = new FormData()
    formData.append("fileId" , {{file.id_}});

    formData.append("depId" , $('#depId').val());
    formData.append("depType", $('#dep_type').val());
    formData.append("rname",$('#remoteName').val());

    var depType = $('#dep_type').val()

    {% for k,v in input_file_types().items() %}
      if (depType === '{{k}}') {
           {{v["get"]}}(formData);
      }
    {%endfor%}

    $.ajax({
        type : "POST",
        processData: false,
        contentType: false,
        url : "/inputfiles/dependency/edit/{{file.id_}}",
        data : formData,
        success : function(data) {
            $('#dependency').html(data)
            $('#edit_dep_modal').modal('hide')
        }
    })


}
function delete_dependency(depId) {
    url = "/inputfiles/dependency/delete/{{file.id_}}/" + depId
    $.post(url,function(data) {
        $('#dependency').html(data)
    })
}






</script>

